---
- hosts: bonchvisors-dpdk
  remote_user: cephadmin
  become: true
  become_user: root
  become_method: sudo

  tasks:

#  - name: install openstack nova compute elements
#    yum:
#     name: "{{ packages }}"
#     state: latest
#    vars:
#     packages:
#     - openstack-neutron-linuxbridge
#     - ebtables
#     - ipset
#     - openstack-nova-compute
#     - openstack-neutron-ml2
#     - openstack-neutron-openvswitch


#  - name: restart openvswitch services
#    systemd:
#     state: restarted
#     enabled: yes
#     daemon_reload: yes
#     name: openvswitch.service

  - name: get public ip address
    shell: echo 172.17.2.$((50+$(echo $HOSTNAME | awk -F "bonchvisor" '{print $2}' | sed 's/^0*//')))
    args:
     executable: /bin/bash
    register: public_ip

  - name: get private ip address
    shell: echo 172.17.3.$((50+$(echo $HOSTNAME | awk -F "bonchvisor" '{print $2}' | sed 's/^0*//')))
    args:
     executable: /bin/bash
    register: private_ip

  - name: configure kernel
	default_hugepagesz=2M hugepagesz=2M hugepages=2048 iommu=pt intel_iommu=on isolcpus=3-5"q

  - name: create openvswitch_agent.ini config file
    template:
     src: /etc/ansible/files/openvswitch_agent.ini
     dest: /etc/neutron/plugins/ml2/openvswitch_agent.ini
     owner: root
     group: root
     mode: 0644


  - name: create ml2_conf.ini config file
    template:
     src: /etc/ansible/files/ml2_conf.ini
     dest: /etc/neutron/plugins/ml2/ml2_conf.ini
     owner: root
     group: root
     mode: 0644

  - name: create nova.conf config file
    template:
     src: /etc/ansible/files/nova.conf
     dest: /etc/nova/nova.conf
     owner: root
     group: root
     mode: 0644
